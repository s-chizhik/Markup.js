var Mark={includes:{},globals:{},delimiter:">",compact:false,_copy:function(d,c){c=c||[];for(var e in d){c[e]=d[e]}return c},_size:function(b){return Array.isArray(b)?b.length:(b||0)},_iter:function(a,b){this.idx=a;this.size=b;this.length=b;this.sign="#";this.toString=function(){return this.idx+this.sign.length-1}},_pipe:function(h,c){var g,f,b,a;if((g=c.shift())){f=g.split(this.delimiter);b=f.shift().trim();try{a=Mark.pipes[b].apply(null,[h].concat(f));h=this._pipe(a,c)}catch(d){}}return h},_eval:function(e,g,h){var a=this._pipe(e,g),b=a,d=-1,c,f;if(Array.isArray(a)){a="";c=b.length;while(++d<c){f={iter:new this._iter(d,c)};a+=h?Mark.up(h,b[d],f):b[d]}}else{if(a instanceof Object){a=Mark.up(h,b)}}return a},_test:function(a,e,c,b){var d=Mark.up(e,c,b).split(/{{\s*else\s*}}/);return(a===false?d[1]:d[0])||""},_bridge:function(h,e){e=e=="."?"\\.":e.replace(/\$/g,"\\$");var f="{{\\s*"+e+"([^/}]+\\w*)?}}|{{/"+e+"\\s*}}",n=new RegExp(f,"g"),p=h.match(n)||[],o,g,m=0,l=0,k=-1,j=0;for(g=0;g<p.length;g++){o=g;k=h.indexOf(p[o],k+1);if(p[o].indexOf("{{/")>-1){l++}else{m++}if(m===l){break}}m=h.indexOf(p[0]);l=m+p[0].length;j=k+p[o].length;return[h.substring(m,j),h.substring(l,k)]}};Mark.parseTags=function(b){var a=/{{(.+?)}}/g;return b.match(a)||[]};Mark.up=function(c,b,a){return Mark.evaluate(c,Mark.parseTags(c),b,a)};Mark.compile=function(b,a){return function(d){var c=Mark.parseTags(b);return Mark.evaluate(b,c,d,a)}};Mark.evaluate=function(m,q,d,r){d=d!==undefined?d:{};r=r!==undefined?r:{};var s,b,g,f=[],k,o,e,p,c,a,n,l=0,h=0;if(r.pipes){this._copy(r.pipes,this.pipes)}if(r.includes){this._copy(r.includes,this.includes)}if(r.globals){this._copy(r.globals,this.globals)}if(r.delimiter){this.delimiter=r.delimiter}if(r.compact!==undefined){this.compact=r.compact}while((s=q[l++])){p=undefined;e="";k=s.indexOf("/}}")>-1;b=s.substr(2,s.length-(k?5:4));b=b.replace(/`(.+?)`/g,function(i,j){return Mark.up("{{"+j+"}}",d)});o=b.trim().indexOf("if ")===0;f=b.split("|");f.shift();b=b.replace(/^\s*if/,"").split("|").shift().trim();g=o?"if":b.split("|")[0];n=d[b];if(o&&!f.length){f=["notempty"]}if(!k&&m.indexOf("{{/"+g)>-1){p=this._bridge(m,g);s=p[0];e=p[1];l+=Mark.parseTags(s).length-1}if(/^{{\s*else\s*}}$/.test(s)){continue}else{if((c=this.globals[b])!==undefined){p=this._eval(c,f,e)}else{if((a=this.includes[b])){if(a instanceof Function){a=a()}p=this._pipe(Mark.up(a,d,r),f)}else{if(b.indexOf("#")>-1){r.iter.sign=b;p=this._pipe(r.iter,f)}else{if(b==="."){p=this._pipe(d,f)}else{if(b.indexOf(".")>-1){b=b.split(".");n=Mark.globals[b[0]];if(n){h=1}else{h=0;n=d}while(n&&h<b.length){n=n[b[h++]]}p=this._eval(n,f,e)}else{if(o){p=this._pipe(n,f)}else{if(Array.isArray(n)){p=this._eval(n,f,e)}else{if(e){p=n?Mark.up(e,n):undefined}else{if(d.hasOwnProperty(b)){p=this._pipe(n,f)}}}}}}}}}}if(Array.isArray(p)){p=this._eval(p,f,e)}if(o){p=this._test(p,e,d,r)}m=m.replace(s,p===undefined?"???":p)}return this.compact?m.replace(/>\s+</g,"><"):m};Mark.pipes={empty:function(a){return !a||(a+"").trim().length===0?a:false},notempty:function(a){return a&&(a+"").trim().length?a:false},blank:function(b,a){return !!b||b===0?b:a},more:function(d,c){return Mark._size(d)>c?d:false},less:function(d,c){return Mark._size(d)<c?d:false},ormore:function(d,c){return Mark._size(d)>=c?d:false},orless:function(d,c){return Mark._size(d)<=c?d:false},between:function(e,d,f){e=Mark._size(e);return e>=d&&e<=f?e:false},equals:function(d,c){return d==c?d:false},notequals:function(d,c){return d!=c?d:false},like:function(b,a){return new RegExp(a,"i").test(b)?b:false},notlike:function(b,a){return !Mark.pipes.like(b,a)?b:false},upcase:function(a){return String(a).toUpperCase()},downcase:function(a){return String(a).toLowerCase()},capcase:function(a){return a.replace(/(?:^|\s)\S/g,function(b){return b.toUpperCase()})},chop:function(a,b){return a.length>b?a.substr(0,b)+"...":a},tease:function(c,d){var b=c.split(/\s+/);return b.slice(0,d).join(" ")+(b.length>d?"...":"")},trim:function(a){return a.trim()},pack:function(a){return a.trim().replace(/\s{2,}/g," ")},round:function(a){return Math.round(+a)},clean:function(a){return String(a).replace(/<\/?[^>]+>/gi,"")},size:function(a){return a.length},length:function(a){return a.length},reverse:function(a){return[].concat(a).reverse()},join:function(a,b){return a.join(b)},limit:function(b,c,a){return b.slice(+a||0,+c+(+a||0))},split:function(b,a){return b.split(a||",")},choose:function(b,c,a){return !!b?c:(a||"")},toggle:function(c,b,a,d){return a.split(",")[b.match(/\w+/g).indexOf(c+"")]||d},sort:function(a,c){var b=function(e,d){return e[c]>d[c]?1:-1};return[].concat(a).sort(c?b:undefined)},fix:function(a,b){return(+a).toFixed(b)},mod:function(a,b){return(+a)%(+b)},divisible:function(a,b){return a&&(+a%b)===0?a:false},even:function(a){return a&&(+a&1)===0?a:false},odd:function(a){return a&&(+a&1)===1?a:false},number:function(a){return parseFloat(a.replace(/[^\-\d.]/g,""))},url:function(a){return encodeURI(a)},bool:function(a){return !!a},falsy:function(a){return !a},first:function(a){return a.idx===0},last:function(a){return a.idx===a.size-1},call:function(b,a){return b[a].apply(b,[].slice.call(arguments,2))},set:function(b,a){Mark.globals[a]=b;return""},log:function(a){console.log(a);return a}};if(typeof String.prototype.trim!=="function"){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}if(typeof module!=="undefined"&&module.exports){module.exports=Mark}else{if(typeof define==="function"&&define.amd){define(function(){return Mark})}};